<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/gun@0.2020.1241/gun.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun@0.2020.1241/lib/webrtc.min.js"></script>
  <style>
    html {
      overscroll-behavior: none;
    }
    
    body {
      background-color: steelblue;
      display: grid;
      gap: 2px;
      --min_width: 400px;
      grid-template-columns: repeat(auto-fit, minmax(var(--min_width), 1fr));
      height: 100vh;
      height: 100dvh;
      margin: 0;
      overscroll-behavior: none;
    }
    
    div {
      background: Canvas;
      min-height: calc(var(--min_width) * 9 / 16);
      overflow: clip;
      position: relative;
    }
    
    button {
      background: aliceblue;
      border: none;
      cursor: default;
      font-family: monospace;
      font-size: 1em;
      inset-block-end: .2rem;
      inset-inline-end: .2rem;
      margin: 0;
      padding-inline: .1rem;
      position: absolute;
      transform-origin: 100% 100%;
      transition: all 1s, color 0s 0s;
      -webkit-user-select: none;
      user-select: none;
    }
    
    button:hover {
      scale: 1.5;
    }
    
    iframe {
      border: none;
      --factor: 2;
      height: calc(100% * var(--factor));
      scale: calc(1 / var(--factor));
      transform-origin: 0 0;
      width: calc(100% * var(--factor));
    }
    
    body > div:only-of-type iframe, .fullscreen iframe {
      --factor: 1;
    }
    
    .stale {
      color: red;
      transition: color 0s 600s;
    }
  </style>
</head>
<body>
  <script>
    'use strict'
    const gun_peers = ['https://gun-manhattan.herokuapp.com/gun', 'https://try.axe.eco/gun', 'https://test.era.eco/gun', 'https://peer.wallie.io/gun']
    const id = location.hash.slice(1) || 'ediking'
    const params = new URLSearchParams(location.search)
    const secret = params.get('secret') || ''
    const group = (params.get('group') || '').toLowerCase()
    const session = params.get('session') || ''
    const gun = Gun({peers: gun_peers, localStorage: false, rtc: {room: id}})
    const pad = gun.get(id)
    
    let keycode
    crypto.subtle.digest('SHA-1', new TextEncoder().encode(secret)).then(r => {
      keycode = btoa(String.fromCharCode(...new Uint8Array(r))).replace(/[+=\/]/g, '').slice(0, secret.length).toLowerCase()
      pad.map().on(update)
      console.log('Broadcast key:', keycode)
      if (keycode)
        alert(`Ask your students to put in the key: ${keycode} (case-insensitive)`)
    })
    
    document.title = ['ðŸ‘ï¸', id, group, session].join('/')
    addEventListener('hashchange', () => location.reload())
    addEventListener('online', () => {
      gun.opt(gun_peers)
      pad.get('heartbeat').put('heartbeat')
    })

    function unfocus() {
        active_before_update.focus()
    }

    function fork(e) {
        const url = e.currentTarget.parentElement.firstChild.src
        if (url)
            window.open(url, '_blank')
    }

    function click(e) {
      if (e.ctrlKey || e.metaKey || e.button == 1)
        fork(e)
      else
        toggle_fullscreen(e, null, null, e.currentTarget.parentElement)
    }

    const divs = {}
    const bad = new Set()
    let active_before_update = document.body

    function update(data, key) {
      if (!bad.has(key) && data?.content && (data.group || '').toLowerCase() == group && (!session || data.session == session)) {
        if (!divs[key]) {
          const div = document.createElement('div')
          if (!isNaN(new Date(+key.split('_')[0]).getTime()))
            for (const d of [...document.querySelectorAll('div'), null])
              if (key.localeCompare(d?.dataset.key || '') == 1) {
                divs[key] = document.body.insertBefore(div, d)
                divs[key].dataset.key = key
                break
              }
          const iframe = divs[key].appendChild(document.createElement('iframe'))
          iframe.sandbox = 'allow-downloads allow-forms allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-scripts'
          iframe.allow = 'accelerometer; ambient-light-sensor; attribution-reporting; autoplay; bluetooth; browsing-topics; camera; captured-surface-control; compute-pressure; cross-origin-isolated; deferred-fetch; deferred-fetch-minimal; display-capture; encrypted-media; fullscreen; geolocation; gyroscope; hid; identity-credentials-get; idle-detection; language-detector; language-model; local-fonts; magnetometer; microphone; midi; otp-credentials; payment; picture-in-picture; proofreader; publickey-credentials-create; publickey-credentials-get; rewriter; screen-wake-lock; serial; storage-access; summarizer; translator; usb; web-share; window-management; writer; xr-spatial-tracking'
          iframe.allowFullscreen = true
          iframe.credentialless = true
          iframe.addEventListener('load', unfocus)
          const button = divs[key].appendChild(document.createElement('button'))
          button.addEventListener('click', click)
          button.addEventListener('fork', fork)
          button.title = 'Fullscreen ([Ctrl+Click] to fork to new tab)'
        }
        
        const iframe = divs[key].firstChild
        if (keycode && data.content.startsWith('http')) {
          iframe.removeAttribute('src')
          iframe.srcdoc = `<h1>Missing remote key - should be: ${keycode}</h1>`
        } else {
          const url = keycode ? new TextDecoder().decode(new Uint8Array([...atob(data.content)].map((c, i) => c.charCodeAt(0) ^ keycode.charCodeAt(i % keycode.length)))) : data.content
          if (url.startsWith(location.href.split('/').slice(0, -1).join('/'))) {
            iframe.removeAttribute('srcdoc')
            active_before_update = document.activeElement
            iframe.src = url
          } else if (url.startsWith('http')) {
            bad.add(key)
            divs[key].remove()
            delete divs[key]
          } else {
            iframe.removeAttribute('src')
            iframe.srcdoc = `<h1>Wrong remote key - should be: ${keycode ? keycode : 'empty (no key)'}</h1>`
          }
        }
        if (divs[key]) {
          const title = divs[key].lastChild
          title.classList.remove('stale')
          const date = new Date(data.modified)
          title.textContent = data.user + (data.user ? '\u200e ' : '') + (!session && data.session ? `(${data.session}) ` : '') + date.toLocaleTimeString()
          title.offsetWidth  // Restart transition. See: https://css-tricks.com/restart-css-animation/
          if (date.toDateString() == new Date(Date.now()).toDateString())
            title.classList.add('stale')
          else
            title.style.opacity = .5
        }
      } else if (divs[key]) {
        divs[key].remove()
        delete divs[key]
      }
    }
    
    
    // FULLSCREEN
    
    let wake_lock
    
    function request_wake_lock() {
      navigator.wakeLock?.request('screen').then(lock => wake_lock = lock).catch(e => console.warn(e.message))
    }
    
    function visibility_change_handler() {
      if (wake_lock && document.visibilityState == 'visible')
        request_wake_lock()
    }
    
    function toggle_fullscreen(event_or_elem, landscape=true, target_screen, elem) {
      event_or_elem?.preventDefault?.()
      elem ??= event_or_elem?.currentTarget || event_or_elem
      const was_not_fullscreen_before = !document.fullscreenElement
      if (was_not_fullscreen_before) {
        if (!elem.dataset.has_fullscreen_handler) {
          elem.dataset.has_fullscreen_handler = true
          elem.addEventListener('fullscreenchange', () => {
            if (elem.classList.toggle('fullscreen')) {
              if (landscape)
                screen.orientation.lock('landscape').catch(e => console.warn(e.message))
                request_wake_lock()
                document.addEventListener('visibilitychange', visibility_change_handler)
              } else
                wake_lock?.release().then(() => wake_lock = null)
          })
        }
        elem.requestFullscreen({navigationUI: 'hide', screen: target_screen || undefined}).catch(e => console.warn(e.message))
      } else
        document.exitFullscreen()
      return was_not_fullscreen_before
    }
  </script>
</body>
</html>